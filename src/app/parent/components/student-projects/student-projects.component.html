<div class="row">
  <!-- No Projects Message -->
  <div *ngIf="!projects || projects.length === 0" class="text-center w-100">
    <p class="f-s-16 text-muted">
      {{ "NO_PROJECTS" | translate }}
    </p>
  </div>

  <!-- Projects List -->
  <div class="col-sm-6 col-lg-4" *ngFor="let project of projects">
    <mat-card class="cardWithShadow card2 position-relative card-hover">
      <img mat-card-image src="/assets/images/blog/blog-img7.jpg" />
      <div
        class="card-overlay h-100 d-flex align-items-end justify-content-end"
      >
        <span
          class="f-s-12 f-w-600 m-y-16 m-r-16 p-y-4 p-x-8 rounded-pill bg-white"
        >
          {{ project.maxScore }} total points
        </span>
      </div>
      <mat-card-content>
        <div class="user-category pt-n70">
          <img
            src="assets/images/profile/projects.png"
            class="rounded-circle pill-center"
            width="40"
          />
        </div>
        <mat-card-title class="m-t-20">{{ project.title }}</mat-card-title>
        <p class="f-s-14">{{ project.description }}</p>

        <!-- Due Date with Indicator -->
        <div class="d-flex align-items-center justify-content-between m-t-12">
          <div>
            <i-tabler
              *ngIf="isLate(project.dueDate)"
              name="alert-triangle"
              class="icon-18 text-error m-r-4 m-t-12"
            ></i-tabler>
            <span
              class="f-s-14"
              [ngClass]="{ 'text-warn': isLate(project.dueDate) }"
            >
              {{ "DUE" | translate }}: {{ project.dueDate | date : "short" }}
            </span>
          </div>
          <span *ngIf="project.isActive" class="f-s-12 text-success">
            {{ "ACTIVE" | translate }}
          </span>
        </div>

        <!-- Actions -->
        <div class="d-flex justify-content-between m-t-16">
          <!-- View Project -->
          <button
            mat-stroked-button
            color="primary"
            (click)="openProjectDetails(project)"
          >
            {{ "VIEW" | translate }}
          </button>

          <!-- Submit Project -->
          <!-- Conditional Actions -->
          <ng-container *ngIf="project.isSubmitted; else submitAction">
            <!-- View Submission -->
            <button
              mat-flat-button
              color="accent"
              (click)="openViewSubmission(project)"
            >
              {{ "VIEW SUBMISSION" | translate }}
            </button>
          </ng-container>
          <ng-template #submitAction>
            <!-- Submit Assignment -->
            <button
              mat-flat-button
              color="warn"
              (click)="openSubmitProject(project)"
            >
              {{ "SUBMIT" | translate }}
            </button>
          </ng-template>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>

<!-- Submit Project Modal -->
<ng-template #submissionModal let-modal>
  <mat-card>
    <mat-card-content>
      <form [formGroup]="submissionForm">
        <div class="modal-header">
          <h5 class="modal-title">{{ "Submit Project" | translate }}</h5>
        </div>
        <div class="modal-body">
          <mat-label class="f-w-600 m-b-8 d-block">{{
            "Comments" | translate
          }}</mat-label>
          <mat-form-field appearance="outline" class="w-100" color="primary">
            <textarea
              matInput
              formControlName="comments"
              rows="5"
              placeholder="{{ 'Enter your comments' | translate }}"
            ></textarea>
          </mat-form-field>

          <!-- File Upload -->
          <mat-label class="f-s-14 f-w-600 m-b-12 d-block text-dark">
            {{ "File Upload" | translate }}
          </mat-label>
          <mat-form-field appearance="outline" class="w-100" color="primary">
            <ngx-mat-file-input [formControl]="fileControl">
            </ngx-mat-file-input>
            <mat-icon matSuffix>folder</mat-icon>
          </mat-form-field>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
  <h3>Changes here</h3>
  <mat-dialog-actions align="end">
    <button mat-stroked-button color="warn" mat-dialog-close>
      {{ "Cancel" | translate }}
    </button>
    <button
      mat-flat-button
      color="primary"
      [mat-dialog-close]="true"
      cdkFocusInitial
      (click)="submitProject()"
    >
      {{ "Submit" | translate }}
    </button>
  </mat-dialog-actions>
</ng-template>

<ng-template #viewSubmission let-modal>
  <mat-card class="cardWithShadow">
    <mat-card-content>
      <mat-card-title>Student Submission Details</mat-card-title>
      <mat-card-subtitle class="mat-body-1">
        Expandable rows to view attachments and notes
      </mat-card-subtitle>
      <div class="table-responsive-sm">
        <table
          mat-table
          [dataSource]="[currentlySelectedStudentSubmissions]"
          multiTemplateDataRows
        >
          <!-- Define Columns Dynamically -->
          <ng-container
            *ngFor="let column of columnsToDisplay"
            [matColumnDef]="column"
          >
            <th
              mat-header-cell
              *matHeaderCellDef
              class="f-w-600 mat-subtitle-1 f-s-14 p-x-24 p-l-0"
            >
              {{ column | titlecase }}
            </th>
            <td mat-cell *matCellDef="let element" class="p-x-24 f-s-14 p-l-0">
              {{ element[column] ?? "None" }}
            </td>
          </ng-container>

          <!-- Expand Button Column -->
          <ng-container matColumnDef="expand">
            <th mat-header-cell *matHeaderCellDef aria-label="row actions">
              &nbsp;
            </th>
            <td mat-cell *matCellDef="let element">
              <button
                mat-icon-button
                aria-label="expand row"
                (click)="
                  expandedElement =
                    expandedElement === element ? null : element;
                  $event.stopPropagation()
                "
              >
                <mat-icon>
                  {{
                    expandedElement === element
                      ? "keyboard_arrow_up"
                      : "keyboard_arrow_down"
                  }}
                </mat-icon>
              </button>
            </td>
          </ng-container>

          <!-- Expanded Detail Row -->
          <ng-container matColumnDef="expandedDetail">
            <td
              mat-cell
              *matCellDef="let element"
              [attr.colspan]="columnsToDisplay.length + 1"
            >
              <div
                [@detailExpand]="
                  element === expandedElement ? 'expanded' : 'collapsed'
                "
                class="p-15 rounded b-1 m-b-16 m-x-18"
              >
                <mat-card-header>
                  <mat-card-title>List with sections</mat-card-title>
                </mat-card-header>
                <mat-card-content class="b-t-1">
                  <mat-list>
                    <!-- Attachments Section -->
                    <div mat-subheader class="mat-body-2 m-b-16 f-w-600">
                      Attachments
                    </div>
                    <ng-container
                      *ngIf="element.attachments?.length; else noAttachments"
                    >
                      <mat-list-item
                        *ngFor="let attachment of element.attachments"
                      >
                        <mat-icon matListItemIcon>folder</mat-icon>
                        <div matListItemTitle class="mat-body-2 f-w-600">
                          {{ attachment.fileName }}
                        </div>
                        <div matListItemLine class="f-s-14 mat-body-1">
                          Uploaded on:
                          {{ attachment.createdDate | date : "short" }}
                        </div>
                        <button
                          mat-stroked-button
                          color="primary"
                          (click)="downloadAttachment(attachment)"
                        >
                          Download
                        </button>
                      </mat-list-item>
                    </ng-container>
                    <ng-template #noAttachments>
                      <p class="text-muted">No attachments available.</p>
                    </ng-template>

                    <mat-divider></mat-divider>

                    <!-- Notes Section -->
                    <div mat-subheader class="mat-body-2 m-y-16 f-w-600">
                      Notes
                    </div>
                    <ng-container *ngIf="element.teacherComments; else noNotes">
                      <mat-list-item>
                        <mat-icon matListItemIcon>note</mat-icon>
                        <div matListItemTitle class="mat-body-2 f-w-600">
                          Teacher's Comments
                        </div>
                        <div matListItemLine class="f-s-14 mat-body-1">
                          {{ element.teacherComments }}
                        </div>
                      </mat-list-item>
                    </ng-container>
                    <ng-template #noNotes>
                      <p class="text-muted">No notes available.</p>
                    </ng-template>
                  </mat-list>
                </mat-card-content>
              </div>
            </td>
          </ng-container>

          <!-- Header and Row Definitions -->
          <tr mat-header-row *matHeaderRowDef="columnsToDisplayWithExpand"></tr>
          <tr
            mat-row
            *matRowDef="let element; columns: columnsToDisplayWithExpand"
            class="example-element-row"
            [class.example-expanded-row]="expandedElement === element"
            (click)="
              expandedElement = expandedElement === element ? null : element
            "
          ></tr>
          <tr
            mat-row
            *matRowDef="let row; columns: ['expandedDetail']"
            class="example-detail-row"
          ></tr>
        </table>
      </div>
    </mat-card-content>
  </mat-card>

  <mat-dialog-actions align="end">
    <button mat-stroked-button color="warn" mat-dialog-close>
      {{ "Close" | translate }}
    </button>
  </mat-dialog-actions>
</ng-template>

<ng-template #viewProjectModal let-modal>
  <mat-card>
    <mat-card-content>
      <div class="modal-header">
        <h3 class="modal-title">{{ "Project Details" | translate }}</h3>
      </div>
      <div class="modal-body">
        <div class="project-detail">
          <div>
            <strong>{{ "Title" | translate }}:</strong>
            {{ currentlySelectedProject.title }}
          </div>
          <div>
            <strong>{{ "Description" | translate }}:</strong>
            {{ currentlySelectedProject.description || "N/A" }}
          </div>
          <div>
            <strong>{{ "Due Date" | translate }}:</strong>
            {{ currentlySelectedProject.dueDate | date : "shortDate" }}
          </div>
          <div>
            <strong>{{ "Created Date" | translate }}:</strong>
            {{ currentlySelectedProject.createdDate | date : "shortDate" }}
          </div>
          <div>
            <strong>{{ "Is Group Project" | translate }}:</strong>
            {{ currentlySelectedProject.isGroupProject ? "Yes" : "No" }}
          </div>
          <div>
            <strong>{{ "Max Score" | translate }}:</strong>
            {{ currentlySelectedProject.maxScore }}
          </div>
          <div>
            <strong>{{ "Subject ID" | translate }}:</strong>
            {{ currentlySelectedProject.subjectId }}
          </div>
          <div>
            <strong>{{ "Class ID" | translate }}:</strong>
            {{ currentlySelectedProject.classId }}
          </div>
          <div>
            <strong>{{ "Created By Faculty ID" | translate }}:</strong>
            {{ currentlySelectedProject.createdByFacultyId }}
          </div>
          <div>
            <strong>{{ "Is Active" | translate }}:</strong>
            {{ currentlySelectedProject.isActive ? "Yes" : "No" }}
          </div>
          <div>
            <strong>{{ "Is Submitted" | translate }}:</strong>
            {{ currentlySelectedProject.isSubmitted ? "Yes" : "No" }}
          </div>
          <div>
            <strong>{{ "Submission ID" | translate }}:</strong>
            {{ currentlySelectedProject.submissionId }}
          </div>
          <div *ngIf="currentlySelectedProject.students?.length">
            <strong>{{ "Students" | translate }}:</strong>
            <ul>
              <li *ngFor="let student of currentlySelectedProject.students">
                {{ student.firstName }} {{ student.lastName }} (ID:
                {{ student.studentId }})
              </li>
            </ul>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
  <mat-dialog-actions align="end">
    <button mat-stroked-button color="warn" mat-dialog-close>
      {{ "Cancel" | translate }}
    </button>
  </mat-dialog-actions>
</ng-template>
