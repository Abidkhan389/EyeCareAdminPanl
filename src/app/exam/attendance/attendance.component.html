<mat-card class="cardWithShadow">
  <!-- Date Picker and Action Buttons -->
  <div class="row justify-content-between">
    <div class="col-lg-4">
      <mat-form-field appearance="outline" class="w-100 hide-hint">
        <mat-label>{{ "Select Date" | translate }}</mat-label>
        <input
          matInput
          [matDatepicker]="picker"
          [formControl]="dateControl"
          (dateChange)="onGetAttendance()"
        />
        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-datepicker #picker></mat-datepicker>
      </mat-form-field>
    </div>
    <div class="col-lg-4 d-flex align-items-center justify-content-end">
      <button
        mat-flat-button
        color="primary"
        (click)="onGetAttendance()"
        [disabled]="!dateControl.value"
      >
        {{ "Get Attendance" | translate }}
      </button>
    </div>
  </div>
</mat-card>

<div *ngIf="isAttendanceTaken" class="m-t-20">
  <mat-card class="cardWithShadow">
    <div class="table-responsive">
      <table mat-table [dataSource]="dataSource" class="w-100">
        <!-- Student ID Column -->
        <ng-container matColumnDef="studentId">
          <th mat-header-cell *matHeaderCellDef class="f-s-16 f-w-600">
            {{ "Student ID" | translate }}
          </th>
          <td mat-cell *matCellDef="let element">{{ element.studentId }}</td>
        </ng-container>

        <!-- Student Name Column -->
        <ng-container matColumnDef="studentName">
          <th mat-header-cell *matHeaderCellDef class="f-s-16 f-w-600">
            {{ "Student Name" | translate }}
          </th>
          <td mat-cell *matCellDef="let element">
            {{ element.studentDto.firstName }} {{ element.studentDto.lastName }}
          </td>
        </ng-container>

        <!-- Attendance Status Column -->
        <ng-container matColumnDef="attendanceStatus">
          <th mat-header-cell *matHeaderCellDef class="f-s-16 f-w-600">
            {{ "Attendance Status" | translate }}
          </th>
          <td mat-cell *matCellDef="let element">
            <ng-container
              *ngIf="
                editingRow && editingRow.attendanceId === element.attendanceId;
                else viewAttendanceStatus
              "
            >
              <mat-form-field appearance="outline" class="w-100 hide-hint">
                <mat-select [(value)]="editingRow.attendanceStatus">
                  <mat-option
                    *ngFor="let status of attendanceStatusOptions"
                    [value]="status.value"
                  >
                    {{ status.label | translate }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </ng-container>
            <ng-template #viewAttendanceStatus>
              @if(element.attendanceStatus == 1) {
              <span
                class="bg-light-warning text-warning mat-body-2 f-w-500 p-x-8 p-y-4 f-s-12 rounded-pill"
              >
                {{ getAttendanceLabel(element.attendanceStatus) | translate }}
              </span>
              } @if(element.attendanceStatus == 0) {
              <span
                class="bg-light-success text-success mat-body-2 f-w-500 p-x-8 p-y-4 f-s-12 rounded-pill"
              >
                {{ getAttendanceLabel(element.attendanceStatus) | translate }}
              </span>
              } @if(element.attendanceStatus == 2) {
              <span
                class="bg-light-error text-error mat-body-2 f-w-500 p-x-8 p-y-4 f-s-12 rounded-pill"
              >
                {{ getAttendanceLabel(element.attendanceStatus) | translate }}
              </span>
              }</ng-template
            >
          </td>
        </ng-container>

        <!-- Comments Column -->
        <ng-container matColumnDef="comments">
          <th mat-header-cell *matHeaderCellDef class="f-s-16 f-w-600">
            {{ "Comments" | translate }}
          </th>
          <td mat-cell *matCellDef="let element">
            <ng-container
              *ngIf="
                editingRow && editingRow.attendanceId === element.attendanceId;
                else viewComments
              "
            >
              <mat-form-field appearance="outline" class="w-100 hide-hint">
                <mat-label>{{ "Comments" | translate }}</mat-label>
                <textarea
                  matInput
                  placeholder="{{ 'Enter your comments' | translate }}"
                  [(ngModel)]="editingRow.comments"
                ></textarea>
              </mat-form-field>
            </ng-container>
            <ng-template #viewComments>{{ element.comments }}</ng-template>
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef class="f-s-16 f-w-600">
            {{ "Actions" | translate }}
          </th>
          <td mat-cell *matCellDef="let element">
            <ng-container
              *ngIf="
                editingRow && editingRow.attendanceId === element.attendanceId;
                else editButton
              "
            >
              <button
                mat-icon-button
                color="primary"
                (click)="saveAttendance(element)"
              >
                <i-tabler name="square-check" class="icon-18"></i-tabler>
              </button>
              <button mat-icon-button color="warn" (click)="cancelEdit()">
                <i-tabler name="circle-x" class="icon-18"></i-tabler>
              </button>
            </ng-container>
            <ng-template #editButton>
              <a
                class="m-r-10 cursor-pointer"
                (click)="editAttendance(element)"
                matTooltip="{{ 'Edit Assignment' | translate }}"
              >
                <i-tabler name="edit" class="icon-18"></i-tabler>
              </a>
            </ng-template>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

        <!-- No Data Message -->
        <tr class="mat-row" *matNoDataRow>
          <td class="mat-cell" colspan="5">
            {{ "No Attendance Records Found" | translate }}
          </td>
        </tr>
      </table>
    </div>
  </mat-card>
</div>

<div *ngIf="!isAttendanceTaken && records.length" class="m-t-20">
  <mat-card class="cardWithShadow">
    <div class="table-responsive">
      <table class="w-100">
        <thead>
          <tr>
            <th class="f-s-16 f-w-600">{{ "Student Name" | translate }}</th>
            <th class="f-s-16 f-w-600">{{ "Status" | translate }}</th>
            <th class="f-s-16 f-w-600">{{ "Notes" | translate }}</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let record of records">
            <td>
              {{ record.studentDto.firstName }}
              {{ record.studentDto.lastName }}
            </td>
            <td>
              <mat-form-field appearance="outline" class="w-100 hide-hint">
                <mat-select [(ngModel)]="record.attendanceStatus">
                  <mat-option
                    *ngFor="let status of attendanceStatusOptions"
                    [value]="status.value"
                  >
                    {{ status.label | translate }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </td>
            <td>
              <mat-form-field appearance="outline" class="w-100 hide-hint">
                <mat-label>{{ "Comments" | translate }}</mat-label>
                <textarea
                  matInput
                  placeholder="{{ 'Enter your comments' | translate }}"
                  [(ngModel)]="record.comments"
                ></textarea>
              </mat-form-field>
            </td>
          </tr>
        </tbody>
      </table>
      <div class="row justify-content-end m-t-20">
        <button mat-flat-button color="primary" (click)="onSubmitAttendance()">
          {{ "Submit Attendance" | translate }}
        </button>
      </div>
    </div>
  </mat-card>
</div>
