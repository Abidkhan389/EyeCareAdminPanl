<mat-card class="cardWithShadow">
  <!-- Loading Spinner -->
  <div *ngIf="isLoading" class="loading-spinner-overlay">
    <mat-spinner></mat-spinner>
  </div>

  <!-- Header Section -->
  <div class="row justify-content-between">
    <!-- Assessment Type Dropdown -->
    <div class="col-lg-4">
      <mat-form-field appearance="outline" class="w-100 hide-hint">
        <mat-label>{{ "Assessment Type" | translate }}</mat-label>
        <mat-select
          [(ngModel)]="selectedAssessmentType"
          (selectionChange)="onAssessmentTypeChange($event.value)"
        >
          <mat-option *ngFor="let type of assessmentTypes" [value]="type">
            {{ type | translate }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <!-- Assessment Dropdown -->
    <div class="col-lg-4">
      <mat-form-field appearance="outline" class="w-100 hide-hint">
        <mat-label>{{ "Assessment" | translate }}</mat-label>
        <mat-select
          [(ngModel)]="selectedAssessment"
          (selectionChange)="onAssessmentChange($event.value)"
        >
          <mat-option
            *ngFor="let assessment of assessments"
            [value]="assessment"
          >
            {{ assessment.name | translate }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>
  </div>

  <!-- Warning Section -->
  <mat-card class="warning-card m-t-20" *ngIf="hasBeenGraded">
    <div class="d-flex align-items-center justify-content-between viewGrade">
      <span class="textColour">
        {{
          "Warning! This assessment has been graded. Regrading will override previous grades."
            | translate
        }}
      </span>
      <button mat-flat-button color="primary" (click)="navigateToGradeView()">
        {{ "View Grades" | translate }}
      </button>
    </div>
  </mat-card>
</mat-card>

<!-- Data Table -->
<mat-card class="cardWithShadow m-t-20">
  <div class="table-responsive">
    <table mat-table [dataSource]="students" class="w-100">
      <!-- Student Name Column -->
      <ng-container matColumnDef="studentName">
        <th mat-header-cell *matHeaderCellDef class="f-s-16 f-w-600">
          {{ "Student Name" | translate }}
        </th>
        <td mat-cell *matCellDef="let student">
          {{ student.firstName }} {{ student.lastName }}
        </td>
      </ng-container>
    
      <!-- Score Column -->
      <ng-container matColumnDef="score">
        <th mat-header-cell *matHeaderCellDef class="f-s-16 f-w-600">
          {{ "Score" | translate }}
        </th>
        <td mat-cell *matCellDef="let student">
          <mat-form-field appearance="outline" class="w-100 hide-hint">
            <input
              matInput
              type="number"
              [(ngModel)]="student.score"
              [min]="0"
              [max]="selectedAssessment?.maxScore"
            />
          </mat-form-field>
        </td>
      </ng-container>
    
      <!-- Feedback Column -->
      <ng-container matColumnDef="feedback">
        <th mat-header-cell *matHeaderCellDef class="f-s-16 f-w-600">
          {{ "Feedback" | translate }}
        </th>
        <td mat-cell *matCellDef="let student" class="feedback-cell">
          <div class="feedback-wrapper">
            <mat-form-field appearance="outline" class="feedback-input">
              <textarea matInput [(ngModel)]="student.feedback"></textarea>
            </mat-form-field>
            <button
              mat-flat-button
              color="primary"
              class="view-submissions-btn"
              *ngIf="student.hasSubmission"
              (click)="viewSubmissions(student.submissionId)"
            > View Submission
            </button>
          </div>
        </td>
      </ng-container>
    
      <!-- *ngIf="student.hasSubmission" -->
      <!-- Question Grading Column -->
      <ng-container matColumnDef="questionGrading">
        <th mat-header-cell *matHeaderCellDef class="f-s-16 f-w-600">
          {{ "Questions" | translate }}
        </th>
        <td mat-cell *matCellDef="let student">
          <button
            mat-flat-button
            color="accent"
            (click)="openQuestionGradingModal(student)"
          >
            {{ "Grade Questions" | translate }}
          </button>
        </td>
      </ng-container>
    
      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>
    
  </div>
</mat-card>

<!-- Submit Button -->
<div class="row justify-content-end m-t-20">
  <button mat-flat-button color="primary" (click)="submitGrades()">
    {{ "Submit All Grades" | translate }}
  </button>
</div>

<!-- Question Grading Modal -->
<ng-template #questionGradingModal let-dialogRef="dialogRef">
  <div class="modal-header p-3 d-flex justify-content-between align-items-center w-100">
    <h4 class="modal-title text-bold-500 font-medium-1 hrStyleForMaring">
      {{ "Grade Questions for" | translate }} {{ student.firstName }}
      {{ student.lastName }}
    </h4>
    <button type="button" mat-icon-button (click)="dialogRef.close()" aria-label="Close">
      <mat-icon>close</mat-icon>
    </button>
  </div>
  <mat-card class="cardWithShadow">
    <!-- <div class="modal-header f-s-16 f-w-600">
      {{ "Grade Questions for" | translate }} {{ student.firstName }}
      {{ student.lastName }}
    </div> -->
    <div class="table-responsive">
      <table mat-table [dataSource]="student.questions ?? []" class="w-100">
        <!-- Question Text Column -->
        <ng-container matColumnDef="question">
          <th mat-header-cell *matHeaderCellDef class="f-s-16 f-w-600">
            {{ "Question" | translate }}
          </th>
          <td mat-cell *matCellDef="let question">
            {{ question.questionText }}
          </td>
        </ng-container>

        <!-- Question Score Column -->
        <ng-container matColumnDef="score">
          <th mat-header-cell *matHeaderCellDef class="f-s-16 f-w-600">
            {{ "Score" | translate }}
          </th>
          <td mat-cell *matCellDef="let question">
            <mat-form-field appearance="outline" class="w-100 hide-hint">
              <input
                matInput
                type="number"
                [(ngModel)]="question.score"
                [min]="0"
                [max]="question.questionScore"
              />
            </mat-form-field>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="questionColumns"></tr>
        <tr mat-row *matRowDef="let question; columns: questionColumns"></tr>
      </table>
    </div>
    <div class="row justify-content-end m-t-20" style="margin-right:25px">
      <button
        mat-flat-button
        color="primary"
        (click)="saveQuestionGrades(student)"
      >
        {{ "Save Grades" | translate }}
      </button>
    </div>
  </mat-card>
</ng-template>
<ng-template #viewSubmission let-modal>
  <mat-card class="cardWithShadow">
    <mat-card-content>
      <mat-card-title>Student Submission Details</mat-card-title>
      <mat-card-subtitle class="mat-body-1">
        Expandable rows to view attachments and notes 
      </mat-card-subtitle>
      <div class="table-responsive-sm">
        <table
          mat-table
          [dataSource]="[currentlySelectedStudentSubmissions]"
          multiTemplateDataRows
        >
          <!-- Define Columns Dynamically -->
          <ng-container
            *ngFor="let column of columnsToDisplay"
            [matColumnDef]="column"
          >
            <th
              mat-header-cell
              *matHeaderCellDef
              class="f-w-600 mat-subtitle-1 f-s-14 p-x-24 p-l-0"
            >
              {{ column | titlecase }}
            </th>
            <td mat-cell *matCellDef="let element" class="p-x-24 f-s-14 p-l-0">
              {{ element[column] ?? "None" }}
            </td>
          </ng-container>

          <!-- Expand Button Column -->
          <ng-container matColumnDef="expand">
            <th mat-header-cell *matHeaderCellDef aria-label="row actions">
              &nbsp;
            </th>
            <td mat-cell *matCellDef="let element">
              <button
                mat-icon-button
                aria-label="expand row"
                (click)="
                  expandedElement =
                    expandedElement === element ? null : element;
                  $event.stopPropagation()
                "
              >
                <mat-icon>
                  {{
                    expandedElement === element
                      ? "keyboard_arrow_up"
                      : "keyboard_arrow_down"
                  }}
                </mat-icon>
              </button>
            </td>
          </ng-container>

          <!-- Expanded Detail Row -->
          <ng-container matColumnDef="expandedDetail">
            <td
              mat-cell
              *matCellDef="let element"
              [attr.colspan]="columnsToDisplay.length + 1"
            >
              <div
                [@detailExpand]="
                  element === expandedElement ? 'expanded' : 'collapsed'
                "
                class="p-15 rounded b-1 m-b-16 m-x-18"
              >
                <mat-card-header>
                  <mat-card-title>List with sections</mat-card-title>
                </mat-card-header>
                <mat-card-content class="b-t-1">
                  <mat-list>
                    <!-- Attachments Section -->
                    <div mat-subheader class="mat-body-2 m-b-16 f-w-600">
                      Attachments
                    </div>
                    <ng-container
                      *ngIf="element.attachments?.length; else noAttachments"
                    >
                      <mat-list-item
                        *ngFor="let attachment of element.attachments"
                      >
                        <mat-icon matListItemIcon>folder</mat-icon>
                        <div matListItemTitle class="mat-body-2 f-w-600">
                          {{ attachment.fileName }}
                        </div>
                        <div matListItemLine class="f-s-14 mat-body-1">
                          Uploaded on:
                          {{ attachment.createdDate | date : "short" }}
                        </div>
                        <button
                          mat-stroked-button
                          color="primary"
                          (click)="downloadAttachment(attachment)"
                        >
                          Download
                        </button>
                      </mat-list-item>
                    </ng-container>
                    <ng-template #noAttachments>
                      <p class="text-muted">No attachments available.</p>
                    </ng-template>

                    <mat-divider></mat-divider>

                    <!-- Notes Section -->
                    <div mat-subheader class="mat-body-2 m-y-16 f-w-600">
                      Notes
                    </div>
                    <ng-container *ngIf="element.teacherComments; else noNotes">
                      <mat-list-item>
                        <mat-icon matListItemIcon>note</mat-icon>
                        <div matListItemTitle class="mat-body-2 f-w-600">
                          Teacher's Comments
                        </div>
                        <div matListItemLine class="f-s-14 mat-body-1">
                          {{ element.teacherComments }}
                        </div>
                      </mat-list-item>
                    </ng-container>
                    <ng-template #noNotes>
                      <p class="text-muted">No notes available.</p>
                    </ng-template>
                  </mat-list>
                </mat-card-content>
              </div>
            </td>
          </ng-container>

          <!-- Header and Row Definitions -->
          <tr mat-header-row *matHeaderRowDef="columnsToDisplayWithExpand"></tr>
          <tr
            mat-row
            *matRowDef="let element; columns: columnsToDisplayWithExpand"
            class="example-element-row"
            [class.example-expanded-row]="expandedElement === element"
            (click)="
              expandedElement = expandedElement === element ? null : element
            "
          ></tr>
          <tr
            mat-row
            *matRowDef="let row; columns: ['expandedDetail']"
            class="example-detail-row"
          ></tr>
        </table>
      </div>
    </mat-card-content>
  </mat-card>

  <mat-dialog-actions align="end">
    <button mat-stroked-button color="warn" mat-dialog-close>
      {{ "Close" | translate }}
    </button>
  </mat-dialog-actions>
</ng-template>

